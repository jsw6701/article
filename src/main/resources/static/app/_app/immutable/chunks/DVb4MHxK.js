import{_ as g}from"./PPVm8Dsz.js";import{w as k,g as a}from"./DujhYGdh.js";import{C as v,D as u}from"./Do2HDaJV.js";import{g as p}from"./t2ZFSGcY.js";import{b as m}from"./CDBHGxnl.js";const n=v("PushNotifications",{}),h="push_settings",f="push_token",c={enabled:!0,breakingNews:!0,bookmarkUpdates:!0,dailyBriefing:!1,trendingAlerts:!0};function y(){const l={token:null,permissionGranted:!1,settings:c,initialized:!1,error:null},{subscribe:o,set:T,update:s}=k(l);function w(){if(typeof window>"u")return c;try{const e=localStorage.getItem(h);if(e)return{...c,...JSON.parse(e)}}catch{}return c}function P(e){typeof window>"u"||localStorage.setItem(h,JSON.stringify(e))}function S(e){typeof window>"u"||localStorage.setItem(f,e)}function _(){return typeof window>"u"?null:localStorage.getItem(f)}return{subscribe:o,async init(){if(!u.isNativePlatform()){s(r=>({...r,initialized:!0}));return}const e=w(),t=_();s(r=>({...r,settings:e,token:t})),this.setupListeners();let i=await n.checkPermissions();i.receive==="granted"?(s(r=>({...r,permissionGranted:!0})),await this.register()):i.receive==="prompt"&&(typeof window<"u"?localStorage.getItem("push_consent_on_signup"):null)==="true"&&(i=await n.requestPermissions(),i.receive==="granted"&&(s(d=>({...d,permissionGranted:!0})),await this.register()),localStorage.removeItem("push_consent_on_signup")),s(r=>({...r,initialized:!0}))},setupListeners(){n.addListener("registration",async e=>{console.log("[Push] Registration token:",e.value),S(e.value),s(t=>({...t,token:e.value,error:null}));try{const{registerPushToken:t}=await g(async()=>{const{registerPushToken:i}=await import("./Do2HDaJV.js").then(r=>r.N);return{registerPushToken:i}},[],import.meta.url);await t(e.value)}catch(t){console.error("[Push] Failed to register token to server:",t)}}),n.addListener("registrationError",e=>{console.error("[Push] Registration error:",e),s(t=>({...t,error:"푸시 알림 등록에 실패했습니다."}))}),n.addListener("pushNotificationReceived",e=>{console.log("[Push] Notification received:",e)}),n.addListener("pushNotificationActionPerformed",e=>{console.log("[Push] Action performed:",e);const t=e.notification.data;t?.issueId?p(`${m}/cards/${t.issueId}`):t?.route&&p(`${m}${t.route}`)})},async requestPermission(){if(!u.isNativePlatform())return!1;try{let e=await n.checkPermissions();return e.receive==="prompt"&&(e=await n.requestPermissions()),e.receive==="granted"?(s(t=>({...t,permissionGranted:!0})),await this.register(),!0):(s(t=>({...t,permissionGranted:!1})),!1)}catch(e){return console.error("[Push] Permission request error:",e),s(t=>({...t,error:"권한 요청 중 오류가 발생했습니다."})),!1}},async register(){if(u.isNativePlatform())try{await n.register()}catch(e){console.error("[Push] Registration error:",e),s(t=>({...t,error:"푸시 알림 등록에 실패했습니다."}))}},async unregister(){if(!u.isNativePlatform())return;const e=a({subscribe:o});if(e.token)try{const{unregisterPushToken:t}=await g(async()=>{const{unregisterPushToken:i}=await import("./Do2HDaJV.js").then(r=>r.N);return{unregisterPushToken:i}},[],import.meta.url);await t(e.token)}catch(t){console.error("[Push] Failed to unregister token from server:",t)}typeof window<"u"&&localStorage.removeItem(f),s(t=>({...t,token:null}))},async updateSettings(e){s(i=>{const r={...i.settings,...e};return P(r),{...i,settings:r}});const t=a({subscribe:o});try{const{updatePushSettings:i}=await g(async()=>{const{updatePushSettings:r}=await import("./Do2HDaJV.js").then(d=>d.N);return{updatePushSettings:r}},[],import.meta.url);await i(t.settings)}catch(i){console.error("[Push] Failed to sync settings:",i)}},async setEnabled(e){if(e){if(!await this.requestPermission())return!1}else await this.unregister();return await this.updateSettings({enabled:e}),!0},setBreakingNews(e){this.updateSettings({breakingNews:e})},setBookmarkUpdates(e){this.updateSettings({bookmarkUpdates:e})},setDailyBriefing(e){this.updateSettings({dailyBriefing:e})},setTrendingAlerts(e){this.updateSettings({trendingAlerts:e})},getSettings(){return a({subscribe:o}).settings},getToken(){return a({subscribe:o}).token}}}const N=y(),O={subscribe:l=>N.subscribe(o=>l(o.settings))};export{N as a,O as p};
