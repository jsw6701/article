import{_ as g}from"./PPVm8Dsz.js";import{w as v,g as a}from"./DujhYGdh.js";import{C as y,D as u}from"./95k2wcHO.js";import{g as m}from"./De4q2J6q.js";import{b as h}from"./DvH0yMmo.js";const n=y("PushNotifications",{}),w="push_settings",f="push_token",c={enabled:!0,breakingNews:!0,bookmarkUpdates:!0,dailyBriefing:!1,trendingAlerts:!0};function N(){const l={token:null,permissionGranted:!1,settings:c,initialized:!1,error:null},{subscribe:o,set:b,update:i}=v(l);let p=!1;function P(){if(typeof window>"u")return c;try{const e=localStorage.getItem(w);if(e)return{...c,...JSON.parse(e)}}catch{}return c}function S(e){typeof window>"u"||localStorage.setItem(w,JSON.stringify(e))}function _(e){typeof window>"u"||localStorage.setItem(f,e)}function k(){return typeof window>"u"?null:localStorage.getItem(f)}return{subscribe:o,async init(){if(!u.isNativePlatform()){i(r=>({...r,initialized:!0}));return}const e=P(),t=k();i(r=>({...r,settings:e,token:t})),this.setupListeners();let s=await n.checkPermissions();s.receive==="granted"?(i(r=>({...r,permissionGranted:!0})),await this.register()):s.receive==="prompt"&&(typeof window<"u"?localStorage.getItem("push_consent_on_signup"):null)==="true"&&(s=await n.requestPermissions(),s.receive==="granted"&&(i(d=>({...d,permissionGranted:!0})),await this.register()),localStorage.removeItem("push_consent_on_signup")),i(r=>({...r,initialized:!0}))},setupListeners(){p||(p=!0,n.addListener("registration",async e=>{console.log("[Push] Registration token:",e.value),_(e.value),i(t=>({...t,token:e.value,error:null}));try{const{registerPushToken:t}=await g(async()=>{const{registerPushToken:s}=await import("./95k2wcHO.js").then(r=>r.N);return{registerPushToken:s}},[],import.meta.url);await t(e.value)}catch(t){console.error("[Push] Failed to register token to server:",t)}}),n.addListener("registrationError",e=>{console.error("[Push] Registration error:",e),i(t=>({...t,error:"푸시 알림 등록에 실패했습니다."}))}),n.addListener("pushNotificationReceived",e=>{console.log("[Push] Notification received:",e)}),n.addListener("pushNotificationActionPerformed",e=>{console.log("[Push] Action performed:",e);const t=e.notification.data;t?.issueId?m(`${h}/cards/${t.issueId}`):t?.route&&m(`${h}${t.route}`)}))},async requestPermission(){if(!u.isNativePlatform())return!1;try{let e=await n.checkPermissions();return e.receive==="prompt"&&(e=await n.requestPermissions()),e.receive==="granted"?(i(t=>({...t,permissionGranted:!0})),await this.register(),!0):(i(t=>({...t,permissionGranted:!1})),!1)}catch(e){return console.error("[Push] Permission request error:",e),i(t=>({...t,error:"권한 요청 중 오류가 발생했습니다."})),!1}},async register(){if(u.isNativePlatform())try{await n.register()}catch(e){console.error("[Push] Registration error:",e),i(t=>({...t,error:"푸시 알림 등록에 실패했습니다."}))}},async unregister(){if(!u.isNativePlatform())return;const e=a({subscribe:o});if(e.token)try{const{unregisterPushToken:t}=await g(async()=>{const{unregisterPushToken:s}=await import("./95k2wcHO.js").then(r=>r.N);return{unregisterPushToken:s}},[],import.meta.url);await t(e.token)}catch(t){console.error("[Push] Failed to unregister token from server:",t)}typeof window<"u"&&localStorage.removeItem(f),i(t=>({...t,token:null}))},async updateSettings(e){i(s=>{const r={...s.settings,...e};return S(r),{...s,settings:r}});const t=a({subscribe:o});try{const{updatePushSettings:s}=await g(async()=>{const{updatePushSettings:r}=await import("./95k2wcHO.js").then(d=>d.N);return{updatePushSettings:r}},[],import.meta.url);await s(t.settings)}catch(s){console.error("[Push] Failed to sync settings:",s)}},async setEnabled(e){if(e){if(!await this.requestPermission())return!1}else await this.unregister();return await this.updateSettings({enabled:e}),!0},setBreakingNews(e){this.updateSettings({breakingNews:e})},setBookmarkUpdates(e){this.updateSettings({bookmarkUpdates:e})},setDailyBriefing(e){this.updateSettings({dailyBriefing:e})},setTrendingAlerts(e){this.updateSettings({trendingAlerts:e})},getSettings(){return a({subscribe:o}).settings},getToken(){return a({subscribe:o}).token}}}const T=N(),G={subscribe:l=>T.subscribe(o=>l(o.settings))};export{T as a,G as p};
